import unittest
from reeds.function_libs.optimization import eds_eoff_rebalancing

import numpy as np


class test_Eoff_rebalancing(unittest.TestCase):
    #data:
    old_eoffs = np.array([[0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97],
                          [0., 19., -6.1, -51.59, -71.97]])
    sampling_stat = {1: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0}, 'max_contributing_state': {1: 0.039626666666666664,
                                                              2: 0.9223466666666666,
                                                              3: 0,
                                                              4: 0.03802666666666667,
                                                              5: 0},
                         'occurence_state': {1: 0.03965333333333333,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     2: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03970666666666667,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03816,
                                             5: 0.0}},
                     3: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.039733333333333336,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03824,
                                             5: 0.0}},
                     4: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03981333333333333,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03816,
                                             5: 0.0}},
                     5: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03970666666666667,
                                             2: 0.9223733333333334,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     6: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03968,
                                             2: 0.9223733333333334,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     7: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03965333333333333,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03813333333333333,
                                             5: 0.0}},
                     8: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.03970666666666667,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.038213333333333335,
                                             5: 0.0}},
                     9: {'minV_state': {1: 0.039626666666666664,
                                              2: 0.9223466666666666,
                                              3: 0,
                                              4: 0.03802666666666667,
                                              5: 0},
                         'max_contributing_state': {1: 0.039626666666666664,
                                  2: 0.9223466666666666,
                                  3: 0,
                                  4: 0.03802666666666667,
                                  5: 0},
                         'occurence_state': {1: 0.039626666666666664,
                                             2: 0.9223466666666666,
                                             3: 0.0,
                                             4: 0.03816,
                                             5: 0.0}},
                     10: {'minV_state': {1: 0.039626666666666664,
                                               2: 0.9223466666666666,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.039626666666666664,
                                   2: 0.9223466666666666,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03968,
                                              2: 0.9223466666666666,
                                              3: 0.0,
                                              4: 0.03818666666666667,
                                              5: 0.0}},
                     11: {'minV_state': {1: 0.039626666666666664,
                                               2: 0.9223466666666666,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.039626666666666664,
                                   2: 0.9223466666666666,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03970666666666667,
                                              2: 0.9223466666666666,
                                              3: 0.0,
                                              4: 0.038053333333333335,
                                              5: 0.0}},
                     12: {'minV_state': {1: 0.039626666666666664,
                                               2: 0.9223466666666666,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.039626666666666664,
                                   2: 0.9223466666666666,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03965333333333333,
                                              2: 0.9223466666666666,
                                              3: 0.0,
                                              4: 0.03818666666666667,
                                              5: 0.0}},
                     13: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03976,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.038213333333333335,
                                              5: 0.0}},
                     14: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03976,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03813333333333333,
                                              5: 2.6666666666666667e-05}},
                     15: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.039733333333333336,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03818666666666667,
                                              5: 5.333333333333333e-05}},
                     16: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03976,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03829333333333333,
                                              5: 2.6666666666666667e-05}},
                     17: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.039786666666666665,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03813333333333333,
                                              5: 0.0}},
                     18: {'minV_state': {1: 0.03965333333333333,
                                               2: 0.92232,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03965333333333333,
                                   2: 0.92232,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.03970666666666667,
                                              2: 0.92232,
                                              3: 0.0,
                                              4: 0.03816,
                                              5: 0.0}},
                     19: {'minV_state': {1: 0.03970666666666667,
                                               2: 0.9222666666666667,
                                               3: 0,
                                               4: 0.03802666666666667,
                                               5: 0},
                          'max_contributing_state': {1: 0.03970666666666667,
                                   2: 0.9222666666666667,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.039786666666666665,
                                              2: 0.9222666666666667,
                                              3: 0.0,
                                              4: 0.03813333333333333,
                                              5: 2.6666666666666667e-05}},
                     20: {'minV_state': {1: 0.039786666666666665,
                                               2: 0.9221066666666666,
                                               3: 0,
                                               4: 0.038106666666666664,
                                               5: 0},
                          'max_contributing_state': {1: 0.03981333333333333,
                                   2: 0.92216,
                                   3: 0,
                                   4: 0.03802666666666667,
                                   5: 0},
                          'occurence_state': {1: 0.04034666666666667,
                                              2: 0.92216,
                                              3: 0.0,
                                              4: 0.03832,
                                              5: 0.0}},
                     21: {'minV_state': {1: 0.05210666666666667,
                                               2: 0.9048,
                                               3: 0,
                                               4: 0.042453333333333336,
                                               5: 0.00064},
                          'max_contributing_state': {1: 0.047786666666666665,
                                   2: 0.9130933333333333,
                                   3: 0,
                                   4: 0.038533333333333336,
                                   5: 0.0005866666666666667},
                          'occurence_state': {1: 0.07306666666666667,
                                              2: 0.92088,
                                              3: 0.0,
                                              4: 0.04477333333333333,
                                              5: 0.00064}},
                     22: {'minV_state': {1: 0.07429333333333334,
                                               2: 0.8751466666666666,
                                               3: 0,
                                               4: 0.049146666666666665,
                                               5: 0.0014133333333333333},
                          'max_contributing_state': {1: 0.06168,
                                   2: 0.89816,
                                   3: 0,
                                   4: 0.03917333333333333,
                                   5: 0.0009866666666666667},
                          'occurence_state': {1: 0.12797333333333333,
                                              2: 0.9201066666666666,
                                              3: 0.0,
                                              4: 0.05416,
                                              5: 0.00152}},
                     23: {'minV_state': {1: 0.13234666666666667,
                                               2: 0.7981333333333334,
                                               3: 0,
                                               4: 0.06610666666666666,
                                               5: 0.0034133333333333333},
                          'max_contributing_state': {1: 0.09509333333333334,
                                   2: 0.86136,
                                   3: 0,
                                   4: 0.041253333333333336,
                                   5: 0.0022933333333333334},
                          'occurence_state': {1: 0.26336,
                                              2: 0.92056,
                                              3: 5.333333333333333e-05,
                                              4: 0.07882666666666667,
                                              5: 0.00408}},
                     24: {'minV_state': {1: 0.26397333333333334,
                                               2: 0.59256,
                                               3: 0,
                                               4: 0.13106666666666666,
                                               5: 0.0124},
                          'max_contributing_state': {1: 0.18458666666666668,
                                   2: 0.7593866666666667,
                                   3: 0,
                                   4: 0.04890666666666667,
                                   5: 0.00712},
                          'occurence_state': {1: 0.5732266666666667,
                                              2: 0.9201066666666666,
                                              3: 0.0,
                                              4: 0.17221333333333333,
                                              5: 0.015226666666666666}},
                     25: {'minV_state': {1: 0.3406133333333333,
                                               2: 0.38144,
                                               3: 2.6666666666666667e-05,
                                               4: 0.25136,
                                               5: 0.02656},
                          'max_contributing_state': {1: 0.26528,
                                   2: 0.6541066666666666,
                                   3: 0,
                                   4: 0.06658666666666667,
                                   5: 0.014026666666666666},
                          'occurence_state': {1: 0.8408533333333333,
                                              2: 0.9153333333333333,
                                              3: 0.00021333333333333333,
                                              4: 0.3388,
                                              5: 0.035973333333333336}},
                     26: {'minV_state': {1: 0.30288,
                                               2: 0.23794666666666667,
                                               3: 0.00010666666666666667,
                                               4: 0.40008,
                                               5: 0.058986666666666666},
                          'max_contributing_state': {1: 0.30277333333333334,
                                   2: 0.58112,
                                   3: 8e-05,
                                   4: 0.09058666666666666,
                                   5: 0.02544},
                          'occurence_state': {1: 0.93952,
                                              2: 0.9251466666666667,
                                              3: 0.00088,
                                              4: 0.5560533333333333,
                                              5: 0.08546666666666666}},
                     27: {'minV_state': {1: 0.11930666666666667,
                                               2: 0.06525333333333333,
                                               3: 0.0007733333333333333,
                                               4: 0.5852266666666667,
                                               5: 0.22944},
                          'max_contributing_state': {1: 0.30952,
                                   2: 0.46224,
                                   3: 0.0013066666666666667,
                                   4: 0.14349333333333333,
                                   5: 0.08344},
                          'occurence_state': {1: 0.95336,
                                              2: 0.9291466666666667,
                                              3: 0.006,
                                              4: 0.9093866666666667,
                                              5: 0.3450933333333333}},
                     28: {'minV_state': {1: 0.06304,
                                               2: 0.027146666666666666,
                                               3: 0.00104,
                                               4: 0.5171466666666666,
                                               5: 0.3916266666666667},
                          'max_contributing_state': {1: 0.29949333333333333,
                                   2: 0.40818666666666664,
                                   3: 0.0033333333333333335,
                                   4: 0.15805333333333332,
                                   5: 0.13093333333333335},
                          'occurence_state': {1: 0.9474666666666667,
                                              2: 0.9267466666666667,
                                              3: 0.0148,
                                              4: 0.9595733333333333,
                                              5: 0.5927733333333334}},
                     29: {'minV_state': {1: 0.03368,
                                               2: 0.012426666666666667,
                                               3: 0.00208,
                                               4: 0.41018666666666664,
                                               5: 0.5416266666666667},
                          'max_contributing_state': {1: 0.2869333333333333,
                                   2: 0.36349333333333333,
                                   3: 0.007306666666666667,
                                   4: 0.16562666666666667,
                                   5: 0.17664},
                          'occurence_state': {1: 0.93312,
                                              2: 0.9258933333333333,
                                              3: 0.0332,
                                              4: 0.9737333333333333,
                                              5: 0.8122666666666667}},
                     30: {'minV_state': {1: 0.02416,
                                               2: 0.00792,
                                               3: 0.0034133333333333333,
                                               4: 0.3724266666666667,
                                               5: 0.59208},
                          'max_contributing_state': {1: 0.2832266666666667,
                                   2: 0.3472266666666667,
                                   3: 0.0132,
                                   4: 0.16821333333333333,
                                   5: 0.18813333333333335},
                          'occurence_state': {1: 0.9276266666666667,
                                              2: 0.9202133333333333,
                                              3: 0.056986666666666665,
                                              4: 0.9749066666666667,
                                              5: 0.8854133333333334}},
                     31: {'minV_state': {1: 0.023013333333333334,
                                               2: 0.0064266666666666665,
                                               3: 0.004026666666666666,
                                               4: 0.35568,
                                               5: 0.6108533333333334},
                          'max_contributing_state': {1: 0.27784, 2: 0.3444, 3: 0.0184, 4: 0.16728, 5: 0.19208},
                          'occurence_state': {1: 0.9229866666666666,
                                              2: 0.9174933333333334,
                                              3: 0.07834666666666666,
                                              4: 0.9746933333333333,
                                              5: 0.9098933333333333}},
                     32: {'minV_state': {1: 0.020346666666666666,
                                               2: 0.005386666666666666,
                                               3: 0.0058133333333333335,
                                               4: 0.34352,
                                               5: 0.6249333333333333},
                          'max_contributing_state': {1: 0.27957333333333334,
                                   2: 0.33448,
                                   3: 0.022933333333333333,
                                   4: 0.16928,
                                   5: 0.19373333333333334},
                          'occurence_state': {1: 0.9164,
                                              2: 0.9098933333333333,
                                              3: 0.10514666666666667,
                                              4: 0.97392,
                                              5: 0.92904}},
                     33: {'minV_state': {1: 0.019573333333333335,
                                               2: 0.004906666666666667,
                                               3: 0.007226666666666667,
                                               4: 0.3378933333333333,
                                               5: 0.6304},
                          'max_contributing_state': {1: 0.27344,
                                   2: 0.32957333333333333,
                                   3: 0.03288,
                                   4: 0.16754666666666668,
                                   5: 0.19656},
                          'occurence_state': {1: 0.90448,
                                              2: 0.9027466666666667,
                                              3: 0.146,
                                              4: 0.9722133333333334,
                                              5: 0.94016}},
                     34: {'minV_state': {1: 0.018533333333333332,
                                               2: 0.00464,
                                               3: 0.008693333333333334,
                                               4: 0.33026666666666665,
                                               5: 0.6378666666666667},
                          'max_contributing_state': {1: 0.2727733333333333,
                                   2: 0.32272,
                                   3: 0.042666666666666665,
                                   4: 0.16634666666666667,
                                   5: 0.19549333333333332},
                          'occurence_state': {1: 0.8903733333333333,
                                              2: 0.8893333333333333,
                                              3: 0.19293333333333335,
                                              4: 0.97,
                                              5: 0.9484}},
                     35: {'minV_state': {1: 0.01664,
                                               2: 0.004186666666666667,
                                               3: 0.010933333333333333,
                                               4: 0.34008,
                                               5: 0.62816},
                          'max_contributing_state': {1: 0.26552,
                                   2: 0.30994666666666665,
                                   3: 0.05768,
                                   4: 0.17144,
                                   5: 0.19541333333333333},
                          'occurence_state': {1: 0.87416,
                                              2: 0.86856,
                                              3: 0.25970666666666664,
                                              4: 0.9656,
                                              5: 0.9501866666666666}},
                     36: {'minV_state': {1: 0.016053333333333333,
                                               2: 0.00392,
                                               3: 0.01296,
                                               4: 0.34717333333333333,
                                               5: 0.6198933333333333},
                          'max_contributing_state': {1: 0.26248,
                                   2: 0.29984,
                                   3: 0.07613333333333333,
                                   4: 0.17562666666666665,
                                   5: 0.18592},
                          'occurence_state': {1: 0.85048,
                                              2: 0.8487733333333334,
                                              3: 0.33776,
                                              4: 0.9611733333333333,
                                              5: 0.95072}},
                     37: {'minV_state': {1: 0.01704,
                                               2: 0.004026666666666666,
                                               3: 0.014293333333333333,
                                               4: 0.34928,
                                               5: 0.61536},
                          'max_contributing_state': {1: 0.26298666666666665,
                                   2: 0.29213333333333336,
                                   3: 0.0892,
                                   4: 0.17552,
                                   5: 0.18016},
                          'occurence_state': {1: 0.83128,
                                              2: 0.8274133333333333,
                                              3: 0.4043733333333333,
                                              4: 0.9552,
                                              5: 0.9506133333333333}},
                     38: {'minV_state': {1: 0.01728,
                                               2: 0.004293333333333333,
                                               3: 0.016533333333333334,
                                               4: 0.34786666666666666,
                                               5: 0.6140266666666667},
                          'max_contributing_state': {1: 0.2572,
                                   2: 0.28613333333333335,
                                   3: 0.10744,
                                   4: 0.16978666666666667,
                                   5: 0.17944},
                          'occurence_state': {1: 0.8118933333333334,
                                              2: 0.81248,
                                              3: 0.47728,
                                              4: 0.9513066666666666,
                                              5: 0.9520533333333333}},
                     39: {'minV_state': {1: 0.014933333333333333,
                                               2: 0.00272,
                                               3: 0.016026666666666668,
                                               4: 0.34176,
                                               5: 0.62456},
                          'max_contributing_state': {1: 0.24597333333333332,
                                   2: 0.26912,
                                   3: 0.136,
                                   4: 0.1776,
                                   5: 0.17130666666666666},
                          'occurence_state': {1: 0.78296,
                                              2: 0.7806666666666666,
                                              3: 0.6314666666666666,
                                              4: 0.9482666666666667,
                                              5: 0.9636}},
                     40: {'minV_state': {1: 0.010533333333333334,
                                               2: 0.0022933333333333334,
                                               3: 0.014693333333333333,
                                               4: 0.33216,
                                               5: 0.64032},
                          'max_contributing_state': {1: 0.24394666666666667,
                                   2: 0.26714666666666664,
                                   3: 0.14032,
                                   4: 0.18005333333333334,
                                   5: 0.16853333333333334},
                          'occurence_state': {1: 0.78712,
                                              2: 0.7858133333333334,
                                              3: 0.6550666666666667,
                                              4: 0.9518133333333333,
                                              5: 0.97456}},
                     41: {'minV_state': {1: 0.009546666666666667,
                                               2: 0.0019733333333333334,
                                               3: 0.012506666666666666,
                                               4: 0.32578666666666667,
                                               5: 0.6501866666666667},
                          'max_contributing_state': {1: 0.24504,
                                   2: 0.26424,
                                   3: 0.14397333333333334,
                                   4: 0.17749333333333334,
                                   5: 0.16925333333333334},
                          'occurence_state': {1: 0.79232,
                                              2: 0.7926933333333334,
                                              3: 0.6739733333333333,
                                              4: 0.95808,
                                              5: 0.9798133333333333}}}

    def test_eoff_correctionF_oneSided(self):
        # params:
        samplingDists = np.array(np.linspace(0.0, 1, 100), ndmin=2)
        expected_res = np.array([[ 5.94128876, 4.92833542, 4.21138897, 3.65601508, 3.20261727, 2.81949309,
                                   2.48775377, 2.1952317,  1.93362714, 1.69702481 ,1.4810598 , 1.28241903,
                                   1.0985283,  0.92734768, 0.76723321, 0.61684058, 0.47505649, 0.34094855,
                                   0.21372811, 0.09272213, -0.02264833, -0.13288492,-0.23842514,-0.33965286,
                                  -0.4369067, -0.53048693, -0.620661,  -0.70766818,-0.79172338, -0.87302037,
                                  -0.95173442, -1.02802461, -1.10203579, -1.17390016,-1.24373877,-1.3116627,
                                  -1.37777415, -1.44216732, -1.50492928, -1.56614064,-1.62587618,-1.68420537,
                                  -1.74119293, -1.79689919, -1.85138049, -1.90468956,-1.95687577,-2.00798546,
                                  -2.05806214, -2.10714675, -2.15527782, -2.20249171,-2.24882272,-2.29430325,
                                  -2.33896397, -2.38283392, -2.42594061, -2.46831014,-2.5099673 ,-2.55093566,
                                  -2.59123762, -2.63089452, -2.66992667, -2.70835346,-2.74619338,-2.78346409,
                                  -2.82018245, -2.85636461, -2.89202599, -2.92718137,-2.96184491,-2.9960302,
                                  -3.02975023, -3.06301751, -3.09584404, -3.12824133,-3.16022048,-3.19179213,
                                  -3.22296655, -3.2537536, -3.28416279, -3.31420329,-3.34388392,-3.37321322,
                                  -3.40219939, -3.43085038, -3.45917384, -3.48717719,-3.51486758,-3.54225192,
                                  -3.5693369, -3.59612901, -3.6226345, -3.64885945,-3.67480973,-3.70049103,
                                  -3.72590888, -3.75106861, -3.77597544, -3.80063438 ]])

        ddEoff = eds_eoff_rebalancing.calculate_Eoff_Correction(samplingDists=samplingDists, _shift_eoff_zero=False, _nstates=5,
                                                                verbose=True)

        np.testing.assert_almost_equal(actual=ddEoff, desired=expected_res, decimal=5)

    def test_eoff_correctionF_oneSided_learningFactor(self):
        # params:
        samplingDists = np.array(np.round(np.linspace(0.0, 1, 10), 1), ndmin=2)
        expected_res = np.array([[ 5.94128876, -0.0, -1.6021545, -2.5671352,  -3.25986537, -4.24426395,
                                      -4.6203952, -4.94688124, -5.23531232, -5.49364085]])
        learningFactors = [1 / (2 ** x) for x in range(3)]

        for lf in learningFactors:
            ddEoff = eds_eoff_rebalancing.calculate_Eoff_Correction(samplingDists=samplingDists, learningFactor=lf,
                                                                    _shift_eoff_zero=False, verbose=True)
            print(str(ddEoff))
            np.testing.assert_almost_equal(actual=ddEoff, desired=expected_res * lf, decimal=5)


    def test_eoff_rebalancing_directCounting_s1Only(self):

        expected_eoffs =np.array([[0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358]])

        old_eoffs = self.old_eoffs
        sampling_stat = self.sampling_stat

        new_eoffs = eds_eoff_rebalancing.rebalance_eoffs_directCounting(old_eoffs=old_eoffs,
                                                            sampling_stat=sampling_stat,
                                                            correct_for_s1_only=True)
        print(list(map(list, new_eoffs)))


        np.testing.assert_almost_equal(actual=new_eoffs, desired=expected_eoffs, decimal=5)

    def test_eoff_rebalancing_directCounting_allS(self):
        expected_eoffs =np.array([[0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.160851019094881, -3.393422524683583, -51.522605731099894, -69.26342252468358],
                                  [0.0, 12.162028986200205, -3.392314673173883, -51.52149787959019, -69.26231467317388],
                                  [0.0, 12.162028986200205, -3.392314673173883, -51.52149787959019, -69.26231467317388],
                                  [0.0, 12.162028986200205, -3.392314673173883, -51.52149787959019, -69.26231467317388],
                                  [0.0, 12.162028986200205, -3.392314673173883, -51.52149787959019, -69.26231467317388],
                                  [0.0, 12.162028986200205, -3.392314673173883, -51.52149787959019, -69.26231467317388],
                                  [0.0, 12.162028986200205, -3.392314673173883, -51.52149787959019, -69.26231467317388],
                                  [0.0, 12.164383441418469, -3.390100455099656, -51.51928366151596, -69.26010045509966],
                                  [0.0, 12.169086448254413, -3.385677946366087, -51.514861152782395, -69.25567794636609],
                                  [0.0, 12.50309857887251, -3.075624972676795, -51.22634868874719, -69.0172588935235],
                                  [0.0, 13.005026152532405, -2.6136716901116976, -50.79133950344317, -68.60298591221185],
                                  [0.0, 13.956069606260753, -1.7639801929567867, -50.02724614198279, -67.9029489941506],
                                  [0.0, 15.686024404814024, -0.3386818323223135, -48.89366011479752, -66.96324158499792],
                                  [0.0, 16.86937466614879, 0.48510583010682407, -48.63576381053022, -66.70157955980169],
                                  [0.0, 17.459250347162186, 0.7811603126578417, -48.93599911295642, -67.11230723170587],
                                  [0.0, 18.056476030422232, 0.6854984366252754, -49.853460286832146, -69.09921307694592],
                                  [0.0, 18.274469987051397, 0.3838036062794403, -50.141398811339975, -70.11196991145296],
                                  [0.0, 18.448234657997702, -0.10518174626840704, -50.3439768557198, -70.86678500948014],
                                  [0.0, 18.525521839535013, -0.6194774333468986, -50.40836894517475, -71.0376335658406],
                                  [0.0, 18.500256486602428, -1.0244139035675994, -50.44046253022888, -71.12858740354652],
                                  [0.0, 18.583019550583543, -1.2865265057161093, -50.45240451319938, -71.13345055219943],
                                  [0.0, 18.566301234575437, -1.8540774695936717, -50.480864366132906, -71.21725800864827],
                                  [0.0, 18.60972332324612, -2.2804392164840883, -50.47059554904396, -71.21065940584387],
                                  [0.0, 18.641676211391253, -2.8747297547778077, -50.599566118840364, -71.27189678295541],
                                  [0.0, 18.69223592996502, -3.429346822273059, -50.679690213384234, -71.18674633974742],
                                  [0.0, 18.757108455555198, -3.740678290974157, -50.673898726056855, -71.11201185169182],
                                  [0.0, 18.754009323886482, -4.174587520762977, -50.65134778362259, -71.15427391949487],
                                  [0.0, 18.793245583679273, -4.77804256753036, -50.85374537377223, -71.15354918957536],
                                  [0.0, 18.791262715445484, -4.8646752003243545, -50.90327034129833, -71.13631942165219],
                                  [0.0, 18.82671344781509, -4.910260848714057, -50.8611173988687, -71.13552155987536]])

        old_eoffs = self.old_eoffs
        sampling_stat = self.sampling_stat


        new_eoffs = eds_eoff_rebalancing.rebalance_eoffs_directCounting(old_eoffs=old_eoffs,
                                                            sampling_stat=sampling_stat,
                                                            correct_for_s1_only=False)
        np.testing.assert_almost_equal(actual=new_eoffs, desired=expected_eoffs, decimal=5)
